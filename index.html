<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APS School Explorer</title>

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="anonymous" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin="anonymous"></script>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#f6f7fb; color:#0f172a; }
    header { padding: 16px 20px; background:#fff; border-bottom:1px solid #e5e7eb; position: sticky; top:0; z-index: 10; }
    h1 { margin:0; font-size: 20px; }
    .wrap { display:grid; grid-template-columns: 340px 1fr; gap: 14px; padding: 14px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius: 12px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .kpis { display:grid; grid-template-columns: repeat(4, minmax(120px,1fr)); gap: 10px; }
    .kpi { padding: 10px; border:1px solid #eef2f7; border-radius: 10px; background:#fbfcff; }
    .kpi .label { font-size: 12px; color:#475569; }
    .kpi .value { font-size: 20px; font-weight: 700; margin-top: 2px; }
    label { display:block; font-size: 12px; color:#475569; margin-top: 10px; }
    input, select { width: 100%; padding: 8px 10px; border-radius: 10px; border:1px solid #e5e7eb; background:#fff; }
    button { width:100%; margin-top: 10px; padding:10px 12px; border-radius: 10px; border:1px solid #e5e7eb; background:#0f172a; color:#fff; cursor:pointer; }
    button.secondary { background:#fff; color:#0f172a; }
    #map { height: 520px; border-radius: 12px; overflow:hidden; border:1px solid #e5e7eb; }
    .table { width:100%; border-collapse: collapse; font-size: 12px; }
    .table th, .table td { padding: 8px; border-bottom: 1px solid #eef2f7; text-align:left; vertical-align: top; }
    .muted { color:#64748b; font-size: 12px; }
    .errorBox { white-space: pre-wrap; background:#fff; border:1px solid #fecaca; color:#991b1b; padding: 12px; border-radius: 12px; }
    @media (max-width: 1100px){
      .wrap { grid-template-columns: 1fr; }
      .kpis { grid-template-columns: repeat(2, minmax(120px,1fr)); }
    }
  </style>
</head>

<body>
  <header>
    <h1>APS School Explorer</h1>
    <div class="muted">Public dashboard â€¢ Data source: <code>data.json</code></div>
  </header>

  <div id="root" class="wrap"></div>

  <script type="module">
    import React from "https://esm.sh/react@18.2.0";
    import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";

    const el = React.createElement;

    function safeNum(x) {
      const n = Number(String(x ?? "").replace(/,/g,""));
      return Number.isFinite(n) ? n : null;
    }
    function toStr(x) {
      if (x === null || x === undefined) return "";
      return String(x).trim();
    }
    function uniq(arr) {
      return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b));
    }

    function normalizeNmCoords(lat, lon) {
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return { lat: null, lon: null, ok: false };
      if (lon > 0 && lon >= 100 && lon <= 115) lon = -lon;
      const withinNm = (lat >= 31.0 && lat <= 37.5 && lon >= -109.5 && lon <= -102.5);
      return { lat, lon, ok: withinNm };
    }

    function downloadCSV(rows, filename="schools_filtered.csv") {
      const headers = Object.keys(rows[0] || {});
      const esc = (v) => `"${String(v ?? "").replaceAll('"','""')}"`;
      const csv = [headers.join(",")].concat(rows.map(r => headers.map(h => esc(r[h])).join(","))).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function App({ raw }) {
      const rows = raw.map((r, i) => {
        const school = toStr(r.school_name);
        const level = toStr(r.level);
        const enrollment = safeNum(r.enrollment);
        const board = toStr(r.school_board_district);
        const calendar = toStr(r.calendar);
        const bilingual = toStr(r.bilingual_education_program);

        const lat0 = safeNum(r.latitude);
        const lon0 = safeNum(r.longitude);
        const norm = normalizeNmCoords(lat0, lon0);

        return {
          id: r.objectid ?? i,
          school_name: school,
          level,
          enrollment: enrollment ?? 0,
          board_district: board,
          calendar_type: calendar,
          bilingual_program: bilingual,
          latitude: norm.lat,
          longitude: norm.lon,
          in_nm: norm.ok
        };
      });

      const [q, setQ] = React.useState("");
      const [level, setLevel] = React.useState("");
      const [board, setBoard] = React.useState("");
      const [calendar, setCalendar] = React.useState("");
      const [bilingual, setBilingual] = React.useState("");

      const levelOpts = uniq(rows.map(r => r.level));
      const boardOpts = uniq(rows.map(r => r.board_district));
      const calOpts = uniq(rows.map(r => r.calendar_type));
      const bilOpts = uniq(rows.map(r => r.bilingual_program));

      const filtered = rows.filter(r => {
        return (!q || r.school_name.toLowerCase().includes(q.toLowerCase())) &&
               (!level || r.level === level) &&
               (!board || r.board_district === board) &&
               (!calendar || r.calendar_type === calendar) &&
               (!bilingual || r.bilingual_program === bilingual);
      });

      const totalSchools = filtered.length;
      const totalEnroll = filtered.reduce((a,r)=>a+(r.enrollment||0),0);

      React.useEffect(() => {
        if (!window.L) return;
        const nmBounds = window.L.latLngBounds([31.2, -109.1], [37.2, -103.0]);

        if (!window.__SKB_MAP__) {
          window.__SKB_MAP__ = window.L.map("map", {
            maxBounds: nmBounds,
            maxBoundsViscosity: 1.0,
            minZoom: 5
          }).setView([34.5, -106.0], 6);

          window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(window.__SKB_MAP__);
          window.__SKB_MARKERS__ = window.L.layerGroup().addTo(window.__SKB_MAP__);
        }

        const map = window.__SKB_MAP__;
        const layer = window.__SKB_MARKERS__;
        layer.clearLayers();

        const pts = filtered.filter(r => r.in_nm && Number.isFinite(r.latitude) && Number.isFinite(r.longitude));
        pts.forEach(r => {
          window.L.circleMarker([r.latitude, r.longitude], { radius: 6 })
            .bindPopup(`<b>${r.school_name}</b><br/>Enrollment: ${r.enrollment}`)
            .addTo(layer);
        });

        if (pts.length) {
          const bounds = window.L.latLngBounds(pts.map(p => [p.latitude, p.longitude]));
          map.fitBounds(bounds.pad(0.2), { maxZoom: 13 });
        } else {
          map.fitBounds(nmBounds, { maxZoom: 7 });
        }
      }, [q, level, board, calendar, bilingual]);

      return el(React.Fragment, null,
        el("div", { className: "card" },
          el("div", { style: { fontWeight: 700 } }, "Filters"),
          el("label", null, "Search school"),
          el("input", { value: q, onChange: e=>setQ(e.target.value) }),

          el("label", null, "School level"),
          el("select", { value: level, onChange: e=>setLevel(e.target.value) },
            el("option", { value: "" }, "All"),
            levelOpts.map(v => el("option", { key:v, value:v }, v))
          ),

          el("label", null, "School board district"),
          el("select", { value: board, onChange: e=>setBoard(e.target.value) },
            el("option", { value: "" }, "All"),
            boardOpts.map(v => el("option", { key:v, value:v }, v))
          ),

          el("label", null, "Calendar type"),
          el("select", { value: calendar, onChange: e=>setCalendar(e.target.value) },
            el("option", { value: "" }, "All"),
            calOpts.map(v => el("option", { key:v, value:v }, v))
          ),

          el("label", null, "Bilingual education program"),
          el("select", { value: bilingual, onChange: e=>setBilingual(e.target.value) },
            el("option", { value: "" }, "All"),
            bilOpts.map(v => el("option", { key:v, value:v }, v))
          ),

          el("button", { onClick: ()=>downloadCSV(filtered) }, "Export filtered CSV")
        ),

        el("div", null,
          el("div", { className:"card" },
            el("div", { className:"kpis" },
              el("div", { className:"kpi" }, el("div",{className:"label"},"Schools"), el("div",{className:"value"}, totalSchools)),
              el("div", { className:"kpi" }, el("div",{className:"label"},"Total enrollment"), el("div",{className:"value"}, totalEnroll.toLocaleString()))
            )
          ),

          el("div", { className:"card", style:{marginTop:14} },
            el("div", { style:{fontWeight:700, marginBottom:8} }, "Map"),
            el("div", { id:"map" })
          )
        )
      );
    }

    async function main() {
      const root = document.getElementById("root");
      const appRoot = ReactDOM.createRoot(root);
      const res = await fetch("./data.json");
      const raw = await res.json();
      appRoot.render(el(App, { raw }));
    }

    main();
  </script>
</body>
</html>
