<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APS School Explorer</title>

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="anonymous" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin="anonymous"></script>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#f6f7fb; color:#0f172a; }
    header { padding: 16px 20px; background:#fff; border-bottom:1px solid #e5e7eb; position: sticky; top:0; z-index: 10; }
    h1 { margin:0; font-size: 20px; }
    .wrap { display:grid; grid-template-columns: 340px 1fr; gap: 14px; padding: 14px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius: 12px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .kpis { display:grid; grid-template-columns: repeat(4, minmax(120px,1fr)); gap: 10px; }
    .kpi { padding: 10px; border:1px solid #eef2f7; border-radius: 10px; background:#fbfcff; }
    .kpi .label { font-size: 12px; color:#475569; }
    .kpi .value { font-size: 20px; font-weight: 700; margin-top: 2px; }
    label { display:block; font-size: 12px; color:#475569; margin-top: 10px; }
    input, select { width: 100%; padding: 8px 10px; border-radius: 10px; border:1px solid #e5e7eb; background:#fff; }
    button { width:100%; margin-top: 10px; padding:10px 12px; border-radius: 10px; border:1px solid #e5e7eb; background:#0f172a; color:#fff; cursor:pointer; }
    button.secondary { background:#fff; color:#0f172a; }
    #map { height: 520px; border-radius: 12px; overflow:hidden; border:1px solid #e5e7eb; }
    .table { width:100%; border-collapse: collapse; font-size: 12px; }
    .table th, .table td { padding: 8px; border-bottom: 1px solid #eef2f7; text-align:left; vertical-align: top; }
    .muted { color:#64748b; font-size: 12px; }
    .errorBox { white-space: pre-wrap; background:#fff; border:1px solid #fecaca; color:#991b1b; padding: 12px; border-radius: 12px; }
    @media (max-width: 1100px){
      .wrap { grid-template-columns: 1fr; }
      .kpis { grid-template-columns: repeat(2, minmax(120px,1fr)); }
    }
  </style>
</head>

<body>
  <header>
    <h1>APS School Explorer</h1>
    <div class="muted">Public dashboard • Data source: <code>data.json</code></div>
  </header>

  <div id="root" class="wrap"></div>

  <script type="module">
    import React from "https://esm.sh/react@18.2.0";
    import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";

    const el = React.createElement;

    function safeNum(x) {
      const n = Number(String(x ?? "").replace(/,/g,""));
      return Number.isFinite(n) ? n : null;
    }
    function toStr(x) {
      if (x === null || x === undefined) return "";
      return String(x).trim();
    }
    function uniq(arr) {
      return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b));
    }

    // New Mexico bounding box safety + longitude sign fix
    function normalizeNmCoords(lat, lon) {
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return { lat: null, lon: null, ok: false };

      // If longitude is accidentally positive (e.g., 106 instead of -106), flip it.
      if (lon > 0 && lon >= 100 && lon <= 115 && lat >= 25 && lat <= 45) lon = -lon;

      // Keep only points within an NM-ish bounding box (slightly padded)
      const withinNm = (lat >= 31.0 && lat <= 37.5 && lon >= -109.5 && lon <= -102.5);
      return { lat, lon, ok: withinNm };
    }

    function truthyFlag(v) {
      const s = toStr(v).toLowerCase();
      return s === "y" || s === "yes" || s === "true" || s === "1" || s === "t";
    }

    function downloadCSV(rows, filename="schools_filtered.csv") {
      if (!rows.length) return;
      const headers = Object.keys(rows[0] || {});
      const esc = (v) => `"${String(v ?? "").replaceAll('"','""')}"`;
      const csv = [headers.join(",")].concat(rows.map(r => headers.map(h => esc(r[h])).join(","))).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function ErrorPanel({ error }) {
      return el("div", { className: "wrap" },
        el("div", { className: "card errorBox" },
          "Dashboard failed to load.\n\n" + error
        ),
        el("div", { className: "card" },
          el("div", { className: "muted" }, "Tip: open DevTools → Console to see the full stack trace.")
        )
      );
    }

    function App({ raw }) {
      const rows = raw.map((r, i) => {
        const school = toStr(r.school_name);
        const level = toStr(r.level);
        const enrollment = safeNum(r.enrollment) ?? 0;

        const abc = toStr(r.abc_community_school);
        const bilingual = toStr(r.bilingual_education_program);
        const calendar = toStr(r.calendar);
        const board = toStr(r.school_board_district);

        const lat0 = safeNum(r.latitude);
        const lon0 = safeNum(r.longitude);
        const norm = normalizeNmCoords(lat0, lon0);

        return {
          id: r.objectid ?? r.id ?? i,
          school_name: school || `School ${i+1}`,
          level,
          enrollment,
          abc_community_school: abc,
          bilingual_education_program: bilingual,
          calendar,
          school_board_district: board,
          latitude: norm.lat,
          longitude: norm.lon,
          in_nm: norm.ok
        };
      });

      const [q, setQ] = React.useState("");
      const [level, setLevel] = React.useState("");
      const [board, setBoard] = React.useState("");
      const [calendar, setCalendar] = React.useState("");
      const [bilingual, setBilingual] = React.useState("");
      const [abc, setAbc] = React.useState("");
      const [selected, setSelected] = React.useState(null);

      const levelOpts = uniq(rows.map(r => r.level));
      const boardOpts = uniq(rows.map(r => r.school_board_district));
      const calOpts = uniq(rows.map(r => r.calendar));
      const bilingualOpts = uniq(rows.map(r => r.bilingual_education_program));
      const abcOpts = uniq(rows.map(r => r.abc_community_school));

      const filtered = rows.filter(r => {
        const matchQ = !q || r.school_name.toLowerCase().includes(q.toLowerCase());
        const matchLevel = !level || r.level === level;
        const matchBoard = !board || r.school_board_district === board;
        const matchCal = !calendar || r.calendar === calendar;
        const matchBil = !bilingual || r.bilingual_education_program === bilingual;
        const matchAbc = !abc || r.abc_community_school === abc;
        return matchQ && matchLevel && matchBoard && matchCal && matchBil && matchAbc;
      });

      const totalSchools = filtered.length;
      const totalEnroll = filtered.reduce((a,r)=>a+(r.enrollment||0),0);
      const abcCount = filtered.filter(r => truthyFlag(r.abc_community_school)).length;
      const bilingualCount = filtered.filter(r => {
        const v = toStr(r.bilingual_education_program).toLowerCase();
        return v.includes("yes") || v.includes("dual") || v.includes("bilingual");
      }).length;

      // Map: hard constrain to NM + only plot points inside NM
      React.useEffect(() => {
        const mapEl = document.getElementById("map");
        if (!mapEl) return;
        if (!window.L) return;

        const nmBounds = window.L.latLngBounds([31.2, -109.1], [37.2, -103.0]);

        if (!window.__SKB_MAP__) {
          window.__SKB_MAP__ = window.L.map("map", {
            zoomControl: true,
            maxBounds: nmBounds,
            maxBoundsViscosity: 1.0,
            minZoom: 5
          }).setView([34.5, -106.0], 6);

          window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 18,
            attribution: "&copy; OpenStreetMap contributors"
          }).addTo(window.__SKB_MAP__);

          window.__SKB_MARKERS__ = window.L.layerGroup().addTo(window.__SKB_MAP__);
        }

        const map = window.__SKB_MAP__;
        map.setMaxBounds(nmBounds);

        const layer = window.__SKB_MARKERS__;
        layer.clearLayers();

        const pts = filtered.filter(r => r.in_nm && Number.isFinite(r.latitude) && Number.isFinite(r.longitude));
        pts.forEach(r => {
          const popup =
            `<b>${r.school_name}</b><br/>` +
            `Level: ${r.level || ""}<br/>` +
            `Enrollment: ${(r.enrollment||0).toLocaleString()}<br/>` +
            `ABC Community School: ${r.abc_community_school || ""}<br/>` +
            `Bilingual Program: ${r.bilingual_education_program || ""}<br/>` +
            `Calendar: ${r.calendar || ""}<br/>` +
            `School Board District: ${r.school_board_district || ""}`;

          const m = window.L.circleMarker([r.latitude, r.longitude], { radius: 6, weight: 1, fillOpacity: 0.7 });
          m.bindPopup(popup);
          m.on("click", () => setSelected(r));
          m.addTo(layer);
        });

        if (pts.length) {
          const bounds = window.L.latLngBounds(pts.map(p => [p.latitude, p.longitude]));
          map.fitBounds(bounds.pad(0.2), { maxZoom: 13 });
        } else {
          map.fitBounds(nmBounds, { maxZoom: 7 });
        }

        map.on("drag", () => map.panInsideBounds(nmBounds, { animate: false }));
      }, [q, level, board, calendar, bilingual, abc]);

      return el(React.Fragment, null,
        // Left sidebar
        el("div", { className: "card" },
          el("div", { style: { fontWeight: 700 } }, "Filters"),

          el("label", null, "Search school"),
          el("input", { value: q, onChange: e=>setQ(e.target.value), placeholder: "Type a school name…" }),

          el("label", null, "School level"),
          el("select", { value: level, onChange: e=>setLevel(e.target.value) },
            el("option", { value: "" }, "All"),
            levelOpts.map(v => el("option", { key:v, value:v }, v))
          ),

          el("label", null, "School board district"),
          el("select", { value: board, onChange: e=>setBoard(e.target.value) },
            el("option", { value: "" }, "All"),
            boardOpts.map(v => el("option", { key:v, value:v }, v))
          ),

          el("label", null, "Calendar"),
          el("select", { value: calendar, onChange: e=>setCalendar(e.target.value) },
            el("option", { value: "" }, "All"),
            calOpts.map(v => el("option", { key:v, value:v }, v))
          ),

          el("label", null, "Bilingual program"),
          el("select", { value: bilingual, onChange: e=>setBilingual(e.target.value) },
            el("option", { value: "" }, "All"),
            bilingualOpts.map(v => el("option", { key:v, value:v }, v))
          ),

          el("label", null, "ABC Community School"),
          el("select", { value: abc, onChange: e=>setAbc(e.target.value) },
            el("option", { value: "" }, "All"),
            abcOpts.map(v => el("option", { key:v, value:v }, v))
          ),

          el("button", { onClick: ()=>downloadCSV(filtered.map(r => ({
            school_name: r.school_name,
            level: r.level,
            enrollment: r.enrollment,
            abc_community_school: r.abc_community_school,
            bilingual_education_program: r.bilingual_education_program,
            calendar: r.calendar,
            school_board_district: r.school_board_district,
            latitude: r.latitude,
            longitude: r.longitude
          }))) }, "Export filtered CSV"),

          el("button", { className:"secondary", onClick: ()=>window.print() }, "Print / Save as PDF"),

          el("div", { className:"muted", style:{marginTop:10} }, "Map is locked to New Mexico.")
        ),

        // Main content
        el("div", null,
          el("div", { className:"card" },
            el("div", { className:"kpis" },
              el("div", { className:"kpi" }, el("div",{className:"label"},"Schools"), el("div",{className:"value"}, totalSchools)),
              el("div", { className:"kpi" }, el("div",{className:"label"},"Total enrollment"), el("div",{className:"value"}, totalEnroll.toLocaleString())),
              el("div", { className:"kpi" }, el("div",{className:"label"},"ABC Community Schools"), el("div",{className:"value"}, abcCount)),
              el("div", { className:"kpi" }, el("div",{className:"label"},"Bilingual program schools"), el("div",{className:"value"}, bilingualCount))
            )
          ),

          el("div", { className:"card", style:{marginTop:14} },
            el("div", { style:{fontWeight:700, marginBottom:8} }, "Map (OpenStreetMap)"),
            el("div", { id:"map" })
          ),

          // RESTORED: school table below map
          el("div", { className:"card", style:{marginTop:14} },
            el("div", { style:{display:"flex", justifyContent:"space-between", alignItems:"baseline"} },
              el("div", { style:{fontWeight:700} }, "Schools"),
              el("div", { className:"muted" }, `Showing ${filtered.length.toLocaleString()} of ${rows.length.toLocaleString()}`)
            ),
            el("table", { className:"table" },
              el("thead", null,
                el("tr", null,
                  el("th", null, "School"),
                  el("th", null, "Level"),
                  el("th", null, "Enroll"),
                  el("th", null, "ABC"),
                  el("th", null, "Bilingual"),
                  el("th", null, "Calendar"),
                  el("th", null, "Board Dist.")
                )
              ),
              el("tbody", null,
                filtered.slice(0, 250).map(r => el("tr", {
                  key: r.id,
                  style: selected && selected.id === r.id ? { background:"#f1f5ff" } : null,
                  onClick: ()=>setSelected(r)
                },
                  el("td", null, r.school_name),
                  el("td", null, r.level),
                  el("td", null, (r.enrollment||0).toLocaleString()),
                  el("td", null, r.abc_community_school),
                  el("td", null, r.bilingual_education_program),
                  el("td", null, r.calendar),
                  el("td", null, r.school_board_district)
                ))
              )
            ),
            filtered.length > 250 ? el("div", { className:"muted", style:{marginTop:8} }, "Showing first 250 rows for performance.") : null
          )
        )
      );
    }

    async function main() {
      const root = document.getElementById("root");
      const appRoot = ReactDOM.createRoot(root);

      try {
        const res = await fetch("./data.json", { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status} while loading data.json`);
        const raw = await res.json();
        if (!Array.isArray(raw)) throw new Error("Expected data.json to be an array of rows.");
        appRoot.render(el(App, { raw }));
      } catch (e) {
        console.error(e);
        appRoot.render(el(ErrorPanel, { error: String(e && e.stack ? e.stack : e) }));
      }
    }

    main();
  </script>
</body>
</html>
